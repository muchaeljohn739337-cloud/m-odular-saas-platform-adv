name: Deploy Cloudflare Worker (API Gateway)

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Root domain (e.g., advancia.app)"
        required: true
      backend_origin:
        description: "Backend origin URL (e.g., https://advancia-backend.onrender.com)"
        required: true

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    steps:
      - name: Validate & Export Cloudflare Secrets
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -e
          echo "Validating Cloudflare secrets..."
          test -n "$CLOUDFLARE_ACCOUNT_ID" || { echo "CLOUDFLARE_ACCOUNT_ID is missing"; exit 1; }
          test -n "$CLOUDFLARE_ZONE_ID" || { echo "CLOUDFLARE_ZONE_ID is missing"; exit 1; }
          test -n "$CLOUDFLARE_API_TOKEN" || { echo "CLOUDFLARE_API_TOKEN is missing"; exit 1; }
          echo "All Cloudflare secrets validated successfully"
          echo "CLOUDFLARE_ACCOUNT_ID=$CLOUDFLARE_ACCOUNT_ID" >> $GITHUB_ENV
          echo "CLOUDFLARE_ZONE_ID=$CLOUDFLARE_ZONE_ID" >> $GITHUB_ENV
          echo "CLOUDFLARE_API_TOKEN=$CLOUDFLARE_API_TOKEN" >> $GITHUB_ENV
          echo "Environment variables exported for workflow"
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Build wrangler.toml from inputs
        working-directory: ./.infrastructure/cloudflare/workers
        run: |
          DOMAIN="${{ github.event.inputs.domain }}"
          test -n "$CLOUDFLARE_ACCOUNT_ID" || { echo "CLOUDFLARE_ACCOUNT_ID missing in secrets"; exit 1; }
          test -n "$CLOUDFLARE_ZONE_ID" || { echo "CLOUDFLARE_ZONE_ID missing in secrets"; exit 1; }
          cat > wrangler.toml <<EOF
          name = "advancia-api-gateway"
          main = "api-gateway.js"
          compatibility_date = "2024-10-01"
          account_id = "$CLOUDFLARE_ACCOUNT_ID"

          [[routes]]
          pattern = "api.${DOMAIN}/*"
          zone_id = "$CLOUDFLARE_ZONE_ID"
          EOF
          echo "wrangler.toml generated"

      - name: Publish Worker
        working-directory: ./.infrastructure/cloudflare/workers
        run: |
          BACKEND_ORIGIN="${{ github.event.inputs.backend_origin }}"
          test -n "$CLOUDFLARE_API_TOKEN" || { echo "CLOUDFLARE_API_TOKEN missing in secrets"; exit 1; }
          test -n "$BACKEND_ORIGIN" || { echo "backend_origin input missing"; exit 1; }
          echo "Publishing Worker to Cloudflare..."
          wrangler publish --var BACKEND_ORIGIN="$BACKEND_ORIGIN" --minify
          echo "Worker published"

      - name: Summary
        run: |
          echo "### Cloudflare Worker Deployed" >> "$GITHUB_STEP_SUMMARY"
          echo "- Domain: ${{ github.event.inputs.domain }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Route: api.${{ github.event.inputs.domain }}/*" >> "$GITHUB_STEP_SUMMARY"
          echo "- Backend Origin: ${{ github.event.inputs.backend_origin }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Worker Name: advancia-api-gateway" >> "$GITHUB_STEP_SUMMARY"
