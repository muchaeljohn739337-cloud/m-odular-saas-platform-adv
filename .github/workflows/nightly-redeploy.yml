name: ðŸ” Nightly Auto-Deploy (Advancia Frontend)

on:
  schedule:
    # Run every day at 3 AM UTC (10 PM EST / 7 PM PST)
    # Adjust cron schedule as needed: https://crontab.guru
    - cron: "0 3 * * *"

  workflow_dispatch: # Allow manual trigger from GitHub Actions tab

jobs:
  auto-deploy:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone for faster checkout

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ”§ Install PowerShell dependencies
        shell: pwsh
        run: |
          Write-Host "âœ… PowerShell $($PSVersionTable.PSVersion) ready" -ForegroundColor Green

      - name: ðŸ” Create .env from GitHub Secrets
        run: |
          echo "# Auto-generated by GitHub Actions - $(date)" > .env
          echo "RENDER_API_KEY=${{ secrets.RENDER_API_KEY }}" >> .env
          echo "RENDER_SERVICE_ID=${{ secrets.RENDER_SERVICE_ID }}" >> .env
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> .env
          echo "CLOUDFLARE_ZONE_ID=${{ secrets.CLOUDFLARE_ZONE_ID }}" >> .env
          echo "CLOUDFLARE_DOMAIN=advanciapayledger.com" >> .env
          echo "âœ… Environment file created"

      - name: ðŸš€ Run Automated Deployment
        shell: pwsh
        run: |
          Write-Host "ðŸ¤– Starting automated deployment..." -ForegroundColor Cyan
          pwsh ./scripts/render-frontend-auto.ps1
        env:
          CI: true

      - name: âœ… Verify Deployment
        run: |
          echo "ðŸŒ Checking site availability..."
          sleep 30  # Wait for deployment to propagate

          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://advanciapayledger.com || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 301 ] || [ "$HTTP_STATUS" -eq 302 ]; then
            echo "âœ… Site is live! HTTP $HTTP_STATUS"
          else
            echo "âš ï¸ Site returned HTTP $HTTP_STATUS (may still be deploying)"
            echo "Check Render dashboard: https://dashboard.render.com"
          fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Site**: https://advanciapayledger.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Render Dashboard](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloudflare Dashboard](https://dash.cloudflare.com)" >> $GITHUB_STEP_SUMMARY
