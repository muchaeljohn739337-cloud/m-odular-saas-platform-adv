name: Cloudflare Infrastructure Setup
on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "setup-all"
        type: choice
        options:
          - setup-dns
          - setup-ssl
          - setup-waf
          - setup-performance
          - setup-all
          - destroy
  push:
    branches:
      - main
    paths:
      - ".infrastructure/cloudflare/**"
      - ".github/workflows/cloudflare-setup.yml"

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  DOMAIN: advancia.app
  BACKEND_ORIGIN: advancia-backend.onrender.com
  FRONTEND_ORIGIN: advancia-frontend.onrender.com
  BACKEND_IP: 203.0.113.45

jobs:
  setup-cloudflare:
    runs-on: ubuntu-latest
    name: Configure Cloudflare Zone

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          echo "âœ… Dependencies installed"

      - name: Validate Secrets
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN secret is missing"
            exit 1
          fi
          if [ -z "$ZONE_ID" ]; then
            echo "âŒ CLOUDFLARE_ZONE_ID secret is missing"
            exit 1
          fi
          echo "âœ… Secrets validated"

      - name: Setup DNS Records
        if: github.event.inputs.action == 'setup-dns' || github.event.inputs.action == 'setup-all' || github.event_name == 'push'
        run: |
          echo "ğŸ§© Creating DNS Records for $DOMAIN..."

          # Function to create DNS record
          create_dns_record() {
            local TYPE=$1
            local NAME=$2
            local CONTENT=$3
            local PROXIED=$4
            local COMMENT=$5
            
            echo "Creating $TYPE record: $NAME â†’ $CONTENT"
            
            RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data "{
                \"type\":\"$TYPE\",
                \"name\":\"$NAME\",
                \"content\":\"$CONTENT\",
                \"proxied\":$PROXIED,
                \"ttl\":1,
                \"comment\":\"$COMMENT\"
              }")
            
            if echo "$RESPONSE" | jq -e '.success' > /dev/null; then
              echo "  âœ… Created successfully"
            else
              ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message')
              if [[ "$ERROR" == *"already exists"* ]]; then
                echo "  â„¹ï¸  Record already exists, skipping"
              else
                echo "  âš ï¸  Error: $ERROR"
              fi
            fi
          }

          # Create DNS records
          # Apex/root: CNAME flattening to frontend origin (Cloudflare will flatten)
          create_dns_record "CNAME" "@" "$FRONTEND_ORIGIN" "true" "Root domain to frontend"
          create_dns_record "CNAME" "api" "$BACKEND_ORIGIN" "true" "API subdomain"
          create_dns_record "CNAME" "www" "$FRONTEND_ORIGIN" "true" "WWW subdomain"
          create_dns_record "CNAME" "admin" "$FRONTEND_ORIGIN" "true" "Admin dashboard"

          echo "âœ… DNS records created/verified"

      - name: Configure SSL/TLS Settings
        if: github.event.inputs.action == 'setup-ssl' || github.event.inputs.action == 'setup-all' || github.event_name == 'push'
        run: |
          echo "ğŸ”’ Configuring SSL/TLS Settings..."

          # Function to update zone setting
          update_setting() {
            local SETTING=$1
            local VALUE=$2
            local DESCRIPTION=$3
            
            echo "Setting $DESCRIPTION..."
            
            RESPONSE=$(curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/$SETTING" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data "{\"value\":$VALUE}")
            
            if echo "$RESPONSE" | jq -e '.success' > /dev/null; then
              echo "  âœ… $DESCRIPTION set successfully"
            else
              ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message')
              echo "  âš ï¸  Error: $ERROR"
            fi
          }

          # SSL Settings
          update_setting "ssl" "\"strict\"" "SSL mode to Full (strict)"
          update_setting "always_use_https" "\"on\"" "Always Use HTTPS"
          update_setting "automatic_https_rewrites" "\"on\"" "Automatic HTTPS Rewrites"
          update_setting "min_tls_version" "\"1.2\"" "Minimum TLS version 1.2"
          update_setting "tls_1_3" "\"on\"" "TLS 1.3"
          update_setting "opportunistic_encryption" "\"on\"" "Opportunistic Encryption"

          echo "âœ… SSL/TLS configured"

      - name: Setup WAF and Security Rules
        if: github.event.inputs.action == 'setup-waf' || github.event.inputs.action == 'setup-all' || github.event_name == 'push'
        run: |
          echo "ğŸ›¡ï¸ Creating WAF and Security Rules..."

          # Get existing rulesets
          RULESETS=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/rulesets" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")

          # Check if custom WAF ruleset exists
          RULESET_ID=$(echo "$RULESETS" | jq -r '.result[] | select(.name=="Advancia Custom WAF") | .id')

          if [ -z "$RULESET_ID" ] || [ "$RULESET_ID" == "null" ]; then
            echo "Creating new WAF ruleset..."
            
            RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/rulesets" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{
                "name": "Advancia Custom WAF",
                "description": "Custom security rules for Advancia Pay Ledger",
                "kind": "zone",
                "phase": "http_request_firewall_custom",
                "rules": [
                  {
                    "action": "block",
                    "expression": "(http.request.uri.path contains \"union\" and http.request.uri.path contains \"select\") or (http.request.uri.path contains \"<script\") or (http.request.uri.path contains \"javascript:\") or (http.request.uri.path contains \"onerror=\")",
                    "description": "Block SQL injection and XSS attempts",
                    "enabled": true
                  },
                  {
                    "action": "block",
                    "expression": "(http.user_agent contains \"sqlmap\") or (http.user_agent contains \"nikto\") or (http.user_agent contains \"masscan\")",
                    "description": "Block malicious scanners",
                    "enabled": true
                  },
                  {
                    "action": "challenge",
                    "expression": "http.request.uri.path contains \"/api/admin\"",
                    "description": "Challenge admin endpoint requests",
                    "enabled": true
                  }
                ]
              }')
            
            if echo "$RESPONSE" | jq -e '.success' > /dev/null; then
              echo "  âœ… WAF ruleset created"
            else
              ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message')
              echo "  âš ï¸  Error: $ERROR"
            fi
          else
            echo "  â„¹ï¸  WAF ruleset already exists (ID: $RULESET_ID)"
          fi

          # Enable Bot Fight Mode (Free)
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/bot_management" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"value":"on"}' > /dev/null

          echo "âœ… Security rules configured"

      - name: Configure Performance Settings
        if: github.event.inputs.action == 'setup-performance' || github.event.inputs.action == 'setup-all' || github.event_name == 'push'
        run: |
          echo "âš¡ Enabling Performance Features..."

          # Enable Brotli compression
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/brotli" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"value":"on"}' | jq -r '.success' && echo "  âœ… Brotli enabled"

          # Enable Auto Minify
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/minify" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"value":{"css":"on","html":"on","js":"on"}}' | jq -r '.success' && echo "  âœ… Auto Minify enabled"

          # Enable Early Hints
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/early_hints" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"value":"on"}' | jq -r '.success' && echo "  âœ… Early Hints enabled"

          # Enable HTTP/2
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/http2" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"value":"on"}' | jq -r '.success' && echo "  âœ… HTTP/2 enabled"

          # Enable HTTP/3
          curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/settings/http3" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"value":"on"}' | jq -r '.success' && echo "  âœ… HTTP/3 enabled"

          echo "âœ… Performance features enabled"

      - name: Create Page Rules
        if: github.event.inputs.action == 'setup-performance' || github.event.inputs.action == 'setup-all'
        run: |
          echo "ğŸ“„ Creating Page Rules..."

          # Get existing page rules
          EXISTING_RULES=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/pagerules" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          # Check if rules already exist
          if echo "$EXISTING_RULES" | jq -e '.result | length > 0' > /dev/null; then
            echo "  â„¹ï¸  Page rules already exist, skipping creation"
          else
            # Rule 1: Bypass cache for API
            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/pagerules" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data "{
                \"targets\": [{\"target\": \"url\", \"constraint\": {\"operator\": \"matches\", \"value\": \"api.$DOMAIN/api/*\"}}],
                \"actions\": [{\"id\": \"cache_level\", \"value\": \"bypass\"}],
                \"priority\": 1,
                \"status\": \"active\"
              }" > /dev/null && echo "  âœ… API bypass rule created"
            
            # Rule 2: Cache static assets
            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/pagerules" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data "{
                \"targets\": [{\"target\": \"url\", \"constraint\": {\"operator\": \"matches\", \"value\": \"$DOMAIN/*.(js|css|jpg|jpeg|png|gif|svg|ico|woff|woff2|ttf|eot)\"}}],
                \"actions\": [
                  {\"id\": \"cache_level\", \"value\": \"cache_everything\"},
                  {\"id\": \"edge_cache_ttl\", \"value\": 2592000},
                  {\"id\": \"browser_cache_ttl\", \"value\": 14400}
                ],
                \"priority\": 2,
                \"status\": \"active\"
              }" > /dev/null && echo "  âœ… Static assets cache rule created"
          fi

          echo "âœ… Page rules configured"

      - name: Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Cloudflare Setup Completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Configuration Summary:"
          echo "  Domain: $DOMAIN"
          echo "  Zone ID: $ZONE_ID"
          echo "  Backend: $BACKEND_ORIGIN"
          echo "  Frontend: $FRONTEND_ORIGIN"
          echo ""
          echo "âœ… Configured:"
          echo "  â€¢ DNS Records (root, api, www, admin)"
          echo "  â€¢ SSL/TLS (Full strict mode, HTTPS redirect)"
          echo "  â€¢ WAF Rules (SQL injection, XSS protection)"
          echo "  â€¢ Performance (Brotli, Minify, HTTP/2, HTTP/3)"
          echo "  â€¢ Page Rules (API bypass, Static caching)"
          echo ""
          echo "ğŸ”— Useful Links:"
          echo "  Dashboard: https://dash.cloudflare.com/"
          echo "  DNS Checker: https://dnschecker.org/#A/$DOMAIN"
          echo "  SSL Test: https://www.ssllabs.com/ssltest/analyze.html?d=$DOMAIN"
          echo ""
          echo "â³ Next Steps:"
          echo "  1. Wait 5-10 minutes for DNS propagation"
          echo "  2. Test endpoints:"
          echo "     - https://$DOMAIN"
          echo "     - https://api.$DOMAIN/api/health"
          echo "     - https://www.$DOMAIN"
          echo "     - https://admin.$DOMAIN"
          echo "  3. Monitor Cloudflare Analytics dashboard"
          echo "  4. Review Security Events for any blocked traffic"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Send Notification
        if: success()
        run: |
          echo "âœ… Workflow completed successfully"
          # Add notification logic here (Slack, Discord, Email, etc.)
