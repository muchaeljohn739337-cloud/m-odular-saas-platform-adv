name: ğŸš€ Advancia Full Deploy (Render + Auto Monitor)

on:
  push:
    branches: ["main"]
  schedule:
    # Every 30 minutes, check health and auto-redeploy if down
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "advancia-deploy"
  cancel-in-progress: false

jobs:
  build:
    name: ğŸ“¦ Build Backend & Frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Build backend
        run: |
          cd backend
          npm ci
          npm run build

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: advancia-build
          path: |
            backend/dist
            frontend/.next

  deploy:
    name: ğŸŒ Deploy to Render + Health Check
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: advancia-build

      - name: Trigger Render Deploy
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
        run: |
          echo "ğŸ“¡ Triggering Render backend deployment..."
          curl -X POST "$RENDER_DEPLOY_HOOK"
          echo "âœ… Render deploy triggered successfully."

      - name: Wait for Render to deploy
        run: |
          echo "â³ Waiting 90 seconds for Render to complete deployment..."
          sleep 90

      - name: Verify Backend Health
        run: |
          echo "ğŸ” Checking backend health at advanciapayledger.com..."
          RETRIES=10
          for i in $(seq 1 $RETRIES); do
            if curl -f https://advanciapayledger.com/api/health; then
              echo "âœ… Backend healthy."
              exit 0
            fi
            echo "Attempt $i/$RETRIES failed, retrying..."
            sleep 6
          done
          echo "âŒ Backend health check failed after $RETRIES attempts"
          exit 1

      - name: Verify Frontend Availability
        run: |
          echo "ğŸ” Checking frontend status..."
          if curl -I https://advanciapayledger.com | grep -E "200|301|302"; then
            echo "âœ… Frontend live and responding."
          else
            echo "âŒ Frontend check failed"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Site: https://advanciapayledger.com"
          echo "ğŸ“Š Backend API: https://advanciapayledger.com/api/health"

  rpa-monitor:
    name: ğŸ¤– Auto Monitor & Self-Heal
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.monitor == 'true')

    steps:
      - name: Check site uptime
        id: health
        run: |
          echo "ğŸ” RPA: Checking site uptime..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://advanciapayledger.com)

          if [ "$STATUS" != "200" ]; then
            echo "âš ï¸ Site down (HTTP $STATUS) â€” triggering auto-redeploy"
            echo "down=true" >> $GITHUB_OUTPUT
            echo "status=$STATUS" >> $GITHUB_OUTPUT
          else
            echo "âœ… Site up and healthy (HTTP $STATUS)"
            echo "down=false" >> $GITHUB_OUTPUT
          fi

      - name: Check API health endpoint
        id: api_health
        run: |
          echo "ğŸ” Checking API health endpoint..."
          if curl -f https://advanciapayledger.com/api/health >/dev/null 2>&1; then
            echo "âœ… API healthy"
            echo "api_down=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ API health check failed"
            echo "api_down=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto trigger redeploy if down
        if: steps.health.outputs.down == 'true' || steps.api_health.outputs.api_down == 'true'
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
        run: |
          echo "ğŸš€ RPA Auto-Heal: Triggering emergency redeploy..."
          curl -X POST "$RENDER_DEPLOY_HOOK"
          echo "âœ… Emergency redeploy triggered by RPA monitor."
          echo "ğŸ“§ Consider setting up notifications for this event."

      - name: Monitor summary
        run: |
          echo "ğŸ“Š RPA Monitor Summary:"
          if [ "${{ steps.health.outputs.down }}" == "true" ]; then
            echo "Site Status: âŒ DOWN"
          else
            echo "Site Status: âœ… UP"
          fi
          if [ "${{ steps.api_health.outputs.api_down }}" == "true" ]; then
            echo "API Status: âŒ DOWN"
          else
            echo "API Status: âœ… UP"
          fi
          if [ "${{ steps.health.outputs.down }}" == "true" ] || [ "${{ steps.api_health.outputs.api_down }}" == "true" ]; then
            echo "Action: ğŸš€ Auto-redeploy triggered"
          else
            echo "Action: âœ… No action needed"
          fi
