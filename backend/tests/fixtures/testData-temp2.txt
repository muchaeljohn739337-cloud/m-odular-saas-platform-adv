export async function cleanTestData() {
  console.log("üßπ Cleaning test data...");
  
  try {
    // Get test user IDs first
    const testUsers = await prisma.user.findMany({
      where: {
        email: {
          in: ["admin@test.com", "user@test.com"],
        },
      },
      select: { id: true },
    });

    const testUserIds = testUsers.map((u) => u.id);

    if (testUserIds.length === 0) {
      console.log("No test users found to clean");
      return;
    }

    // Delete in order to respect foreign key constraints
    await prisma.supportTicket.deleteMany({
      where: { userId: { in: testUserIds } },
    });

    await prisma.userTier.deleteMany({
      where: { userId: { in: testUserIds } },
    });

    await prisma.reward.deleteMany({
      where: { userId: { in: testUserIds } },
    });

    // Get wallet IDs for token transactions
    const wallets = await prisma.tokenWallet.findMany({
      where: { userId: { in: testUserIds } },
      select: { id: true },
    });
    const walletIds = wallets.map((w) => w.id);

    if (walletIds.length > 0) {
      await prisma.tokenTransaction.deleteMany({
        where: { walletId: { in: walletIds } },
      });
    }

    await prisma.tokenWallet.deleteMany({
      where: { userId: { in: testUserIds } },
    });

    await prisma.transaction.deleteMany({
      where: { userId: { in: testUserIds } },
    });
    
    // Delete test users last
    await prisma.user.deleteMany({
      where: { id: { in: testUserIds } },
    });

    console.log("‚úÖ Test data cleaned");
  } catch (error) {
    console.error("‚ùå Error cleaning test data:", error);
    // Don't throw - allow tests to continue
  }
}

